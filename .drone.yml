kind: pipeline
name: arch-package

steps:
- name: build
  image: archlinux/base
  pull: always
  volumes:
    - name: build-products
      path: /tmp/products
  commands:
    - pacman --noconfirm -Syyu
    - pacman --noconfirm --needed -S wget
    - wget https://packages.aunali1.com/archlinux/linux-mbp-5.1.21-1-x86_64.pkg.tar.xz
    - #useradd builduser -m
    - #passwd -d builduser
    - #printf 'builduser ALL=(ALL) ALL\n' | tee -a /etc/sudoers # passwordless sudo
    - #chown -R builduser:builduser ./
    - #sudo -u builduser gpg --recv-keys 38DBBDC86092693E
    - #sudo -u builduser bash -c 'export MAKEFLAGS=-j14 && makepkg -s --noconfirm'
    - ls -lah *.pkg.tar.xz
    - cp *.pkg.tar.xz /tmp/products

- name: publish-server
  image: appleboy/drone-scp
  volumes:
    - name: build-products
      path: /tmp/products
  settings:
    host: tel.aunali1.com
    username:
      from_secret: ingress_user
    password:
      from_secret: ingress_password
    port: 22
    rm: true
    strip_components: 2
    target: /srv/ftp/packages/archlinux
    source:
      - /tmp/products/*.pkg.tar.xz

- name: publish-github
  image: plugins/github-release
  volumes:
    - name: build-products
      path: /tmp/products
  settings:
    api_key:
      from_secret: github_token
    files: /tmp/products/*.pkg.tar.xz
    prerelease: yes

volumes:
- name: build-products
  temp: {}
